       """
       Tracing utils
       """
       
>>>>>> from __future__ import annotations
       
>>>>>> from typing import Any
>>>>>> from typing import Callable
>>>>>> from typing import Sequence
>>>>>> from typing import Tuple
       
       
>>>>>> _Writer = Callable[[str], object]
>>>>>> _Processor = Callable[[Tuple[str, ...], Tuple[Any, ...]], object]
       
       
>>>>>> class TagTracer:
>>>>>>     def __init__(self) -> None:
    1:         self._tags2proc: dict[tuple[str, ...], _Processor] = {}
    1:         self._writer: _Writer | None = None
    1:         self.indent = 0
       
>>>>>>     def get(self, name: str) -> TagTracerSub:
    4:         return TagTracerSub(self, (name,))
       
>>>>>>     def _format_message(self, tags: Sequence[str], args: Sequence[object]) -> str:
>>>>>>         if isinstance(args[-1], dict):
>>>>>>             extra = args[-1]
>>>>>>             args = args[:-1]
               else:
>>>>>>             extra = {}
       
>>>>>>         content = " ".join(map(str, args))
>>>>>>         indent = "  " * self.indent
       
>>>>>>         lines = ["{}{} [{}]\n".format(indent, content, ":".join(tags))]
       
>>>>>>         for name, value in extra.items():
>>>>>>             lines.append(f"{indent}    {name}: {value}\n")
       
>>>>>>         return "".join(lines)
       
>>>>>>     def _processmessage(self, tags: tuple[str, ...], args: tuple[object, ...]) -> None:
 1072:         if self._writer is not None and args:
>>>>>>             self._writer(self._format_message(tags, args))
 1072:         try:
 1072:             processor = self._tags2proc[tags]
 1072:         except KeyError:
 1072:             pass
               else:
>>>>>>             processor(tags, args)
       
>>>>>>     def setwriter(self, writer: _Writer | None) -> None:
>>>>>>         self._writer = writer
       
>>>>>>     def setprocessor(self, tags: str | tuple[str, ...], processor: _Processor) -> None:
>>>>>>         if isinstance(tags, str):
>>>>>>             tags = tuple(tags.split(":"))
               else:
>>>>>>             assert isinstance(tags, tuple)
>>>>>>         self._tags2proc[tags] = processor
       
       
>>>>>> class TagTracerSub:
>>>>>>     def __init__(self, root: TagTracer, tags: tuple[str, ...]) -> None:
    5:         self.root = root
    5:         self.tags = tags
       
>>>>>>     def __call__(self, *args: object) -> None:
 1072:         self.root._processmessage(self.tags, args)
       
>>>>>>     def get(self, name: str) -> TagTracerSub:
    1:         return self.__class__(self.root, self.tags + (name,))
