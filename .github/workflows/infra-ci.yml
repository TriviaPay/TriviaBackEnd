name: Infra CI

on:
  pull_request:
    paths:
      - "infra/**"
      - ".github/workflows/infra-ci.yml"
  push:
    branches: ["main"]
    paths:
      - "infra/**"
      - ".github/workflows/infra-ci.yml"
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3

      - name: Terraform fmt
        run: terraform fmt -check -recursive
        working-directory: infra

      - name: Terraform init (no backend)
        run: terraform init -backend=false
        working-directory: infra

      - name: Terraform validate
        run: terraform validate
        working-directory: infra

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4

      - name: TFLint init
        run: tflint --init
        working-directory: infra

      - name: TFLint
        run: tflint -f compact
        working-directory: infra

      - name: tfsec
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: infra

      - name: Checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: infra

  plan:
    runs-on: ubuntu-latest
    needs: lint
    if: ${{ github.ref == 'refs/heads/main' }}
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3

      - name: Install OCI CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gettext-base
          python3 -m pip install --upgrade pip
          python3 -m pip install oci-cli

      - name: Set WIF audience default
        run: |
          if [ -z "${OCI_WIF_AUDIENCE:-}" ]; then
            echo "OCI_WIF_AUDIENCE=https://github.com/${GITHUB_REPOSITORY}" >> "$GITHUB_ENV"
          fi
        env:
          OCI_WIF_AUDIENCE: ${{ vars.OCI_WIF_AUDIENCE }}

      - name: OCI WIF (OIDC) Login
        uses: gtrevorrow/oci-token-exchange-action@v1
        with:
          domain_base_url: ${{ secrets.OCI_WIF_DOMAIN_BASE_URL }}
          oci_tenancy: ${{ secrets.OCI_TENANCY_OCID }}
          oci_region: ${{ secrets.OCI_REGION }}
          oidc_client_identifier: ${{ vars.OCI_WIF_CLIENT_IDENTIFIER }}
          ci_platform: github
        env:
          OIDC_AUDIENCE: ${{ env.OCI_WIF_AUDIENCE }}

      - name: Terraform init (remote backend)
        run: |
          terraform init \
            -backend-config="bucket=${OCI_STATE_BUCKET}" \
            -backend-config="namespace=${OCI_STATE_NAMESPACE}" \
            -backend-config="region=${OCI_STATE_REGION}" \
            -backend-config="compartment_ocid=${OCI_STATE_COMPARTMENT_OCID}"
        working-directory: infra
        env:
          OCI_STATE_BUCKET: ${{ secrets.OCI_STATE_BUCKET }}
          OCI_STATE_NAMESPACE: ${{ secrets.OCI_STATE_NAMESPACE }}
          OCI_STATE_REGION: ${{ secrets.OCI_STATE_REGION }}
          OCI_STATE_COMPARTMENT_OCID: ${{ secrets.OCI_STATE_COMPARTMENT_OCID }}

      - name: Terraform plan
        run: terraform plan -input=false -out=plan.tfplan
        working-directory: infra
        env:
          TF_VAR_tenancy_ocid: ${{ secrets.OCI_TENANCY_OCID }}
          TF_VAR_compartment_ocid: ${{ secrets.OCI_COMPARTMENT_OCID }}
          TF_VAR_compartment_name: ${{ secrets.OCI_COMPARTMENT_NAME }}
          TF_VAR_region: ${{ secrets.OCI_REGION }}
          TF_VAR_instance_image_id: ${{ secrets.OCI_INSTANCE_IMAGE_ID }}
          TF_VAR_ocir_namespace: ${{ secrets.OCI_OCIR_NAMESPACE }}
          TF_VAR_ocir_repo_name: ${{ secrets.OCI_OCIR_REPO }}
          TF_VAR_ocir_registry: ${{ secrets.OCI_OCIR_REGISTRY }}

      - name: Verify plan has no secret payloads
        run: |
          terraform show -no-color plan.tfplan > /tmp/plan.txt
          if rg -q "secret_content" /tmp/plan.txt; then
            if ! rg -q "CHANGEME" /tmp/plan.txt; then
              echo "Plan output contains secret_content without placeholder; aborting."
              exit 1
            fi
          fi
        working-directory: infra
